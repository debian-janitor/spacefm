From cf19fb3c7e63fff2a14aa981013d2851a1ba81fc Mon Sep 17 00:00:00 2001
From: IgnorantGuru <ignorantguru@gmx.com>
Date: Wed, 20 Jan 2016 17:14:01 -0700
Subject: [PATCH] Rename dlg canonicalize Copy Target/Link Target target when
 possible

---
 ChangeLog               |  2 ++
 src/ptk/ptk-clipboard.c | 24 ++++--------------------
 src/ptk/ptk-file-misc.c | 30 ++++++++++++++++++++++++++++--
 src/ptk/ptk-file-misc.h |  2 ++
 4 files changed, 36 insertions(+), 22 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 896c075..aae579c 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,5 @@
+1.0.5+next
+    Rename dlg canonicalize Copy Target/Link Target target when possible
 1.0.5   2016-01-20:
     recreate too small cached thumbnails #584
     read $XDG_TEMPLATES_DIR via glib for user-dirs.dirs support #581
diff --git a/src/ptk/ptk-clipboard.c b/src/ptk/ptk-clipboard.c
index 6afd69a..51305b1 100644
--- a/src/ptk/ptk-clipboard.c
+++ b/src/ptk/ptk-clipboard.c
@@ -15,6 +15,7 @@
 
 #include "vfs-file-info.h"
 #include "ptk-file-task.h"
+#include "ptk-file-misc.h"  // for get_real_link_target()
 #include "vfs-file-task.h"
 #include "ptk-utils.h"  //MOD
 
@@ -457,9 +458,6 @@ void ptk_clipboard_paste_targets( GtkWindow* parent_win,
     gchar* file_path;
     gint missing_targets = 0;
     char* str;
-    char buf[ PATH_MAX + 1 ];
-    char* canon;
-    ssize_t len;
     struct stat64 stat;
     
     PtkFileTask* task;
@@ -512,24 +510,10 @@ void ptk_clipboard_paste_targets( GtkWindow* parent_win,
             {
                 if ( g_file_test( file_path, G_FILE_TEST_IS_SYMLINK ) )
                 {
-                    str = file_path;
                     // canonicalize target
-                    canon = g_strdup( realpath( file_path, buf ) );
-                    if ( canon )
-                        file_path = canon;
-                    else
-                    {
-                        /* fall back to immediate target if canonical target
-                         * missing.
-                         * g_file_read_link() doesn't behave like readlink,
-                         * gives nothing if final target missing */
-                        len = readlink( file_path, buf, PATH_MAX );
-                        if ( len > 0 )
-                            file_path = g_strndup( buf, len );
-                        else
-                            file_path = NULL;
-                    }
-                    g_free( str );
+                    str = get_real_link_target( file_path );
+                    g_free( file_path );
+                    file_path = str;
                 }
                 if ( file_path )
                 {
diff --git a/src/ptk/ptk-file-misc.c b/src/ptk/ptk-file-misc.c
index 171092a..a15c72b 100644
--- a/src/ptk/ptk-file-misc.c
+++ b/src/ptk/ptk-file-misc.c
@@ -20,6 +20,7 @@
 #include <sys/stat.h>
 #include <errno.h>
 #include <unistd.h>
+#include <stdlib.h> /* for realpath */
 
 #include <glib/gi18n.h>
 #include "ptk-utils.h"
@@ -193,6 +194,31 @@ void ptk_delete_files( GtkWindow* parent_win,
     ptk_file_task_run( task );
 }
 
+char* get_real_link_target( const char* link_path )
+{
+    char buf[ PATH_MAX + 1 ];
+    char* canon;
+    ssize_t len;
+    struct stat64 stat;
+    char* target_path;
+
+    if ( !link_path )
+        return NULL;
+    
+    // canonicalize target
+    if ( !( target_path = g_strdup( realpath( link_path, buf ) ) ) )
+    {
+        /* fall back to immediate target if canonical target
+         * missing.
+         * g_file_read_link() doesn't behave like readlink,
+         * gives nothing if final target missing */
+        len = readlink( link_path, buf, PATH_MAX );
+        if ( len > 0 )
+            target_path = g_strndup( buf, len );
+    }
+    return target_path;
+}
+
 static void select_file_name_part( GtkEntry* entry )
 {
     GtkEditable * editable = GTK_EDITABLE( entry );
@@ -3082,7 +3108,7 @@ int ptk_rename_file( DesktopWindow* desktop, PtkFileBrowser* file_browser,
                     from_path = bash_quote( mset->full_path );
                 else
                 {
-                    str = g_file_read_link( mset->full_path, NULL );
+                    str = get_real_link_target( mset->full_path );
                     if ( !str )
                     {
                         ptk_show_error( GTK_WINDOW( mset->dlg ), _("Copy Target Error"),
@@ -3130,7 +3156,7 @@ int ptk_rename_file( DesktopWindow* desktop, PtkFileBrowser* file_browser,
                     from_path = bash_quote( mset->full_path );
                 else
                 {
-                    str = g_file_read_link( mset->full_path, NULL );
+                    str = get_real_link_target( mset->full_path );
                     if ( !str )
                     {
                         ptk_show_error( GTK_WINDOW( mset->dlg ), _("Link Target Error"),
diff --git a/src/ptk/ptk-file-misc.h b/src/ptk/ptk-file-misc.h
index 268b2a1..7c431ec 100644
--- a/src/ptk/ptk-file-misc.h
+++ b/src/ptk/ptk-file-misc.h
@@ -74,6 +74,8 @@ void ptk_file_misc_rootcmd( DesktopWindow* desktop, PtkFileBrowser* file_browser
                                                 GList* sel_files,
                                                 char* cwd, char* setname ); //sfm
 
+char* get_real_link_target( const char* link_path );
+
 G_END_DECLS
 
 #endif
